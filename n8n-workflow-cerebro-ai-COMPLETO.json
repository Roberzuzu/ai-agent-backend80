{
  "name": "ğŸ§  Control AI desde Telegram - Cerebro AI",
  "nodes": [
    {
      "parameters": {
        "updates": ["message"]
      },
      "id": "telegram-trigger-1",
      "name": "ğŸ“± Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [240, 300],
      "webhookId": "cerebro-ai-telegram"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/"
            }
          ]
        }
      },
      "id": "if-command",
      "name": "ğŸ”€ Â¿Es Comando?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// Extraer comando y argumentos\nconst text = $input.item.json.message.text;\nconst parts = text.split(' ');\nconst command = parts[0].toLowerCase();\nconst args = parts.slice(1);\nconst userId = $input.item.json.message.from.id;\nconst chatId = $input.item.json.message.chat.id;\n\nreturn {\n  command: command,\n  args: args,\n  original_text: text,\n  chat_id: chatId,\n  user_id: `telegram_${userId}`,\n  username: $input.item.json.message.from.username || 'unknown',\n  first_name: $input.item.json.message.from.first_name || 'Usuario'\n};"
      },
      "id": "parse-command",
      "name": "âš™ï¸ Parse Command",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 180]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "/ayuda",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "or"
              },
              "renameOutput": true,
              "outputKey": "ayuda"
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "/status",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "status"
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "/memoria",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "memoria"
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "/procesar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "procesar"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "switch-command",
      "name": "ğŸ”„ Route Command",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [900, 180]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=ğŸ§  *Cerebro AI - Control Total desde Telegram*\n\n*ğŸ¯ Comandos Directos:*\nâ€¢ `/ayuda` - Ver esta ayuda\nâ€¢ `/status` - Estado del sistema AI\nâ€¢ `/memoria` - Ver tu historial (Ãºltimas 5)\nâ€¢ `/procesar [ID]` - Procesar producto con AI\n\n*ğŸ’¬ Lenguaje Natural (escribe lo que necesites):*\n\nğŸ“¦ *Productos:*\nâ€¢ \"Busca 10 herramientas elÃ©ctricas tendencia\"\nâ€¢ \"Procesa el producto 4146 con AI\"\nâ€¢ \"Actualiza el stock del producto 100 a 50\"\nâ€¢ \"Crea un cupÃ³n del 20% para sierras\"\n\nğŸ“Š *AnÃ¡lisis:*\nâ€¢ \"Dame las estadÃ­sticas del sitio\"\nâ€¢ \"Analiza las ventas del Ãºltimo mes\"\nâ€¢ \"Analiza la competencia de taladros\"\n\nğŸ¨ *Creatividad:*\nâ€¢ \"Genera 2 imÃ¡genes de sierra circular\"\nâ€¢ \"Crea contenido para blog sobre herramientas\"\n\n*El Cerebro AI tiene 18 herramientas disponibles* ğŸš€\n*Usa memoria persistente con RAG* ğŸ§ ",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-help",
      "name": "ğŸ’¬ Send Help",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1120, 80]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://wpmoneyhub.preview.emergentagent.com/api/agent/status",
        "options": {}
      },
      "id": "get-status",
      "name": "ğŸ“Š Get Agent Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=ğŸ“Š *Estado del Cerebro AI*\n\nğŸ¤– *Agente:* {{ $('ğŸ“Š Get Agent Status').item.json.agente_activo ? 'âœ… Activo' : 'âŒ Inactivo' }}\nğŸ”§ *Herramientas:* {{ $('ğŸ“Š Get Agent Status').item.json.herramientas_disponibles }}\nğŸ’¾ *Conversaciones:* {{ $('ğŸ“Š Get Agent Status').item.json.conversaciones_totales }}\nğŸ§  *Memorias:* {{ $('ğŸ“Š Get Agent Status').item.json.memorias_guardadas }}\n\n*âš¡ CaracterÃ­sticas:*\nâ€¢ Memoria persistente: {{ $('ğŸ“Š Get Agent Status').item.json.caracteristicas.memoria_persistente ? 'âœ…' : 'âŒ' }}\nâ€¢ RAG habilitado: {{ $('ğŸ“Š Get Agent Status').item.json.caracteristicas.rag_enabled ? 'âœ…' : 'âŒ' }}\nâ€¢ BÃºsqueda semÃ¡ntica: {{ $('ğŸ“Š Get Agent Status').item.json.caracteristicas.busqueda_semantica ? 'âœ…' : 'âŒ' }}\nâ€¢ Embeddings OpenAI: {{ $('ğŸ“Š Get Agent Status').item.json.caracteristicas.embeddings ? 'âœ…' : 'âŒ' }}\n\n_Modelo: Perplexity Pro (sonar-pro)_",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-status",
      "name": "ğŸ“¤ Send Status",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://wpmoneyhub.preview.emergentagent.com/api/agent/memory/{{ $json.user_id }}?limit=5",
        "options": {}
      },
      "id": "get-memory",
      "name": "ğŸ§  Get Memory",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 320]
    },
    {
      "parameters": {
        "jsCode": "const memories = $('ğŸ§  Get Memory').item.json.memories || [];\nconst chatId = $('âš™ï¸ Parse Command').item.json.chat_id;\nconst firstName = $('âš™ï¸ Parse Command').item.json.first_name;\n\nif (memories.length === 0) {\n  return {\n    chat_id: chatId,\n    text: `ğŸ“ Hola ${firstName}!\\n\\n*No tienes memorias guardadas aÃºn.*\\n\\nEmpieza a usar el Cerebro AI y tu historial se guardarÃ¡ automÃ¡ticamente con bÃºsqueda semÃ¡ntica (RAG).\\n\\n_Prueba: \"Dame las estadÃ­sticas del sitio\"_`\n  };\n}\n\nlet text = `ğŸ“ *Tus Ãºltimas ${memories.length} memorias*\\n\\n`;\n\nmemories.forEach((mem, idx) => {\n  const date = new Date(mem.timestamp);\n  const dateStr = date.toLocaleDateString('es-ES', {day: '2-digit', month: 'short'});\n  const timeStr = date.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});\n  \n  const cmdPreview = mem.command.length > 45 ? mem.command.substring(0, 45) + '...' : mem.command;\n  \n  text += `${idx + 1}. *${cmdPreview}*\\n`;\n  text += `   ğŸ“… ${dateStr} a las ${timeStr}\\n\\n`;\n});\n\ntext += \"\\n_El sistema usa RAG para recordar contexto relevante_\";\n\nreturn {\n  chat_id: chatId,\n  text: text\n};"
      },
      "id": "format-memory",
      "name": "âœ¨ Format Memory",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 320]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-memory",
      "name": "ğŸ“¤ Send Memory",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1560, 320]
    },
    {
      "parameters": {
        "jsCode": "// Preparar comando de procesamiento\nconst args = $json.args || [];\nconst chatId = $json.chat_id;\nconst userId = $json.user_id;\n\nif (args.length === 0) {\n  return {\n    error: true,\n    chat_id: chatId,\n    message: \"âŒ *Formato incorrecto*\\n\\nUsa: `/procesar [ID]`\\n\\nEjemplo: `/procesar 4146`\"\n  };\n}\n\nconst productId = args[0];\n\nif (!/^\\d+$/.test(productId)) {\n  return {\n    error: true,\n    chat_id: chatId,\n    message: \"âŒ *ID invÃ¡lido*\\n\\nEl ID debe ser un nÃºmero.\\n\\nEjemplo: `/procesar 4146`\"\n  };\n}\n\nreturn {\n  error: false,\n  chat_id: chatId,\n  user_id: userId,\n  command: `Procesa el producto ${productId} con AI: genera descripciÃ³n SEO, calcula precio Ã³ptimo, crea 2 imÃ¡genes profesionales y actualiza todo en WooCommerce`,\n  product_id: productId\n};"
      },
      "id": "parse-procesar",
      "name": "ğŸ”§ Parse Procesar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 440]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-error",
      "name": "âš ï¸ Check Error",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1340, 440]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-error",
      "name": "âŒ Send Error",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1560, 380]
    },
    {
      "parameters": {
        "jsCode": "// Lenguaje natural\nconst text = $input.item.json.message.text;\nconst userId = $input.item.json.message.from.id;\nconst chatId = $input.item.json.message.chat.id;\nconst firstName = $input.item.json.message.from.first_name || 'Usuario';\n\nreturn {\n  command: text,\n  user_id: `telegram_${userId}`,\n  chat_id: chatId,\n  first_name: firstName,\n  original_message: $input.item.json.message\n};"
      },
      "id": "parse-natural",
      "name": "ğŸ’¬ Parse Natural Language",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 420]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=ğŸ§  *Analizando tu solicitud...*\n\n\"{{ $json.command }}\"\n\n_Cerebro AI procesando con Perplexity Pro..._",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-processing",
      "name": "â³ Send Processing",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [900, 420]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wpmoneyhub.preview.emergentagent.com/api/agent/execute",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ command: $json.command, user_id: $json.user_id }) }}",
        "options": {
          "timeout": 180000
        }
      },
      "id": "execute-ai",
      "name": "ğŸ¤– Execute Cerebro AI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 420]
    },
    {
      "parameters": {
        "jsCode": "const result = $input.item.json;\nconst chatId = $('ğŸ’¬ Parse Natural Language').item.json.chat_id;\nconst firstName = $('ğŸ’¬ Parse Natural Language').item.json.first_name;\n\nif (!result.success) {\n  return {\n    chat_id: chatId,\n    text: `âŒ *Error ${firstName}*\\n\\n${result.error || 'Error desconocido procesando tu solicitud.'}\\n\\n_Intenta reformular el comando o usa /ayuda_`\n  };\n}\n\nlet text = `âœ… *${result.mensaje || 'Completado'}*\\n\\n`;\n\nif (result.plan) {\n  text += `ğŸ“‹ *Plan:* ${result.plan}\\n\\n`;\n}\n\nif (result.resultados && result.resultados.length > 0) {\n  text += `*ğŸ”§ Resultados (${result.resultados.length}):*\\n\\n`;\n  \n  result.resultados.forEach((res, idx) => {\n    const herramienta = res.herramienta || 'Herramienta';\n    const resultado = res.resultado || {};\n    const success = resultado.success;\n    \n    if (success) {\n      text += `${idx + 1}. âœ… *${herramienta}*\\n`;\n      \n      // Agregar detalles especÃ­ficos\n      if (resultado.productos) {\n        text += `   ğŸ“¦ Productos: ${resultado.productos.total || 0}\\n`;\n        if (resultado.productos.sin_stock) {\n          text += `   âš ï¸ Sin stock: ${resultado.productos.sin_stock}\\n`;\n        }\n      }\n      \n      if (resultado.ventas) {\n        text += `   ğŸ’° Ã“rdenes: ${resultado.ventas.total_ordenes || 0}\\n`;\n        text += `   ğŸ’µ Ingresos: â‚¬${(resultado.ventas.ingresos_totales || 0).toFixed(2)}\\n`;\n      }\n      \n      if (resultado.mensaje) {\n        const msg = resultado.mensaje.length > 80 ? resultado.mensaje.substring(0, 80) + '...' : resultado.mensaje;\n        text += `   â„¹ï¸ ${msg}\\n`;\n      }\n      \n      if (resultado.total) {\n        text += `   ğŸ“Š Total: ${resultado.total}\\n`;\n      }\n      \n      text += '\\n';\n    } else {\n      const error = (resultado.error || 'Error').substring(0, 60);\n      text += `${idx + 1}. âŒ *${herramienta}*\\n   ${error}\\n\\n`;\n    }\n  });\n}\n\nif (result.completado) {\n  text += '\\nâœ¨ _Comando completado y guardado en memoria_';\n}\n\nreturn {\n  chat_id: chatId,\n  text: text\n};"
      },
      "id": "format-result",
      "name": "âœ¨ Format Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 420]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-result",
      "name": "ğŸ“¤ Send Result",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1560, 420]
    }
  ],
  "connections": {
    "ğŸ“± Telegram Trigger": {
      "main": [
        [
          {
            "node": "ğŸ”€ Â¿Es Comando?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Â¿Es Comando?": {
      "main": [
        [
          {
            "node": "âš™ï¸ Parse Command",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ’¬ Parse Natural Language",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ Parse Command": {
      "main": [
        [
          {
            "node": "ğŸ”„ Route Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Route Command": {
      "main": [
        [
          {
            "node": "ğŸ’¬ Send Help",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“Š Get Agent Status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ§  Get Memory",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ”§ Parse Procesar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Get Agent Status": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  Get Memory": {
      "main": [
        [
          {
            "node": "âœ¨ Format Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ¨ Format Memory": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Parse Procesar": {
      "main": [
        [
          {
            "node": "âš ï¸ Check Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš ï¸ Check Error": {
      "main": [
        [
          {
            "node": "âŒ Send Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ¤– Execute Cerebro AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¬ Parse Natural Language": {
      "main": [
        [
          {
            "node": "â³ Send Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³ Send Processing": {
      "main": [
        [
          {
            "node": "ğŸ¤– Execute Cerebro AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Execute Cerebro AI": {
      "main": [
        [
          {
            "node": "âœ¨ Format Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ¨ Format Result": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-01-15T14:00:00.000Z",
  "versionId": "cerebro-ai-complete-v2"
}
